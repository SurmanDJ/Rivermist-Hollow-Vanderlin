name: Sync from Vanderlin

on:
  schedule:
    - cron: "0 3 * * *"   # runs daily at 3am UTC
  workflow_dispatch:       # allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Noctra repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Add Vanderlin remote and fetch
        run: |
          git remote add vanderlin https://github.com/Monkestation/Vanderlin.git
          git fetch vanderlin
          git fetch origin
          
      - name: Create or update sync branch
        run: |
          if git ls-remote --exit-code --heads origin sync-from-vander; then
            echo "Sync branch exists, checking it out"
            git checkout -B sync-from-vander origin/sync-from-vander
          else
            echo "Sync branch doesn't exist, creating from main"
            git checkout -b sync-from-vander origin/main
          fi
          
      - name: Sync Vanderlin changes (excluding .github)
        id: merge_step
        run: |
          echo "=== Checking for new changes ==="
          vanderlin_head=$(git rev-parse vanderlin/main)
          echo "Upstream Vanderlin commit: $vanderlin_head"

          # Bring in everything except .github/
          git checkout vanderlin/main -- . ':!/.github'

          # Stage and commit only if changes exist
          if ! git diff --quiet; then
            git add -A
            git commit -m "Sync from Vanderlin (excluding .github) $vanderlin_head $(date)"
            echo "merge_status=success" >> $GITHUB_OUTPUT
          else
            echo "No new changes to sync (after excluding .github)"
            echo "merge_status=no_changes" >> $GITHUB_OUTPUT
          fi
          
      - name: Push sync branch
        if: steps.merge_step.outputs.merge_status != 'no_changes'
        run: |
          git push origin sync-from-vander
          
      - name: Create Pull Request
        if: steps.merge_step.outputs.merge_status != 'no_changes'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          existing_pr=$(gh pr list --base main --head sync-from-vander --json number --jq '.[0].number' || echo "")

          pr_title="Sync updates from Vanderlin"
          pr_body="**Sync completed (excluding .github folder)**"

          if [ -z "$existing_pr" ]; then
            gh pr create \
              --base main \
              --head sync-from-vander \
              --title "$pr_title" \
              --body "$pr_body"
          else
            echo "PR #$existing_pr already exists, updating..."
            gh pr edit $existing_pr --title "$pr_title" --body "$pr_body"
          fi
